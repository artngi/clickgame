<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈÄ£Êâì„Ç≤„Éº„É† - „Çè„Çâ‰∫∫ÂΩ¢„Äê„É©„É≥„ÇØÁß∞Âè∑Áâà„Äë</title>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation; 
            overflow: hidden;
        }

        #game-container {
            background: #34495e;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 420px;
            max-height: 95vh;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .rank-display {
            background: #8e44ad;
            border-radius: 10px;
            padding: 8px;
            margin-bottom: 10px;
            border: 2px solid #9b59b6;
        }
        #current-rank {
            font-weight: bold;
            color: #f1c40f;
            font-size: 1.1rem;
            text-shadow: 0 0 5px rgba(241, 196, 15, 0.5);
        }

        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        #event-timer-display {
            background: #e74c3c;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            flex: 1;
            font-weight: bold;
        }

        .status-panel {
            background: #1a252f;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        .status-item { font-size: 0.9rem; margin: 2px 0; }
        .highlight { color: #f1c40f; font-weight: bold; font-size: 1.2rem; }

        #boss-hp-container {
            display: none;
            width: 100%;
            background: #444;
            height: 20px;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            border: 2px solid #000;
        }
        #boss-hp-bar {
            width: 100%;
            height: 100%;
            background: #ff4757;
            transition: width 0.1s;
        }

        #doll-container {
            position: relative;
            display: inline-block;
            margin: 10px 0;
            flex-shrink: 0;
            min-height: 120px;
        }

        #straw-doll {
            font-size: clamp(60px, 20vw, 100px);
            cursor: pointer;
            display: inline-block;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }

        .multiplier-config {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        #input-multiplier { width: 60px; text-align: center; }

        @keyframes random-shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(var(--sx), var(--sy)) rotate(var(--sr)); }
            50% { transform: translate(calc(var(--sx) * -0.8), calc(var(--sy) * -0.8)) rotate(calc(var(--sr) * -0.8)); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .shake-active { animation: random-shake 0.08s linear forwards; }

        .shop { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 5px;
        }
        
        .item-box {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .item-box.full-width { grid-column: span 2; }

        .upgrade-btn { 
            background: #27ae60; 
            border: none; 
            padding: 8px 4px; 
            color: white; 
            border-radius: 8px; 
            cursor: pointer;
            transition: 0.2s;
        }
        .upgrade-btn:disabled { background: #7f8c8d; opacity: 0.6; }

        .damage-popup {
            position: absolute;
            color: #ff4757;
            font-weight: bold;
            pointer-events: none;
            animation: float-up 0.6s ease-out forwards;
        }
        @keyframes float-up {
            0% { opacity: 1; transform: translate(0, 0) scale(1.2); }
            100% { opacity: 0; transform: translate(var(--rx), -80px) scale(0.8); }
        }

        .event-active-banner {
            background: #f1c40f;
            color: #000;
            padding: 5px;
            font-weight: bold;
            font-size: 0.8rem;
            border-radius: 5px;
            margin-bottom: 5px;
            display: none;
        }

        .reset-area { margin-top: 15px; border-top: 1px solid #5d6d7e; padding-top: 10px; }
        #btn-reset { background: #c0392b; color: #ecf0f1; border: none; padding: 6px 12px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="rank-display">
            ÁèæÂú®„ÅÆ„É©„É≥„ÇØ: <span id="current-rank">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
        </div>

        <div class="top-controls">
            <div id="event-timer-display">Ê¨°„Åæ„Åß: 1:30</div>
        </div>

        <div id="event-banner" class="event-active-banner"></div>

        <div class="status-panel">
            <div class="status-item">„Éù„Ç§„É≥„Éà: <span id="points" class="highlight">0</span> pt</div>
            <div class="status-item">Á∑è„ÉÄ„É°„Éº„Ç∏: <span id="total-damage">0</span></div>
        </div>

        <div id="boss-hp-container"><div id="boss-hp-bar"></div></div>

        <div id="doll-container">
            <div id="straw-doll">üåæ</div>
        </div>

        <div class="multiplier-config">
            <label for="input-multiplier">‰∏ÄÊã¨Ë≥ºÂÖ•:</label>
            <input type="number" id="input-multiplier" value="1" min="1">
        </div>

        <div class="shop">
            <div class="item-box">
                <span style="font-size:0.7rem">Ââ£ Lv<span id="cur-lv-sword">0</span></span>
                <button class="upgrade-btn" id="btn-sword">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv</span>
                    <span class="cost-tag"><span id="cost-sword">10</span> pt</span>
                </button>
            </div>
            <div class="item-box">
                <span style="font-size:0.7rem">ÈäÉ Lv<span id="cur-lv-gun">0</span></span>
                <button class="upgrade-btn" id="btn-gun">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv</span>
                    <span class="cost-tag"><span id="cost-gun">100</span> pt</span>
                </button>
            </div>
            <div class="item-box">
                <span style="font-size:0.7rem">„Ç∏„Çß„É† Lv<span id="cur-lv-gem">0</span></span>
                <button class="upgrade-btn" id="btn-gem">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv</span>
                    <span class="cost-tag"><span id="cost-gem">500</span> pt</span>
                </button>
            </div>
            <div class="item-box">
                <span style="font-size:0.7rem">„Çø„É¨„ÉÉ„Éà Lv<span id="cur-lv-turret">0</span></span>
                <button class="upgrade-btn" id="btn-turret">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv</span>
                    <span class="cost-tag"><span id="cost-turret">1000</span> pt</span>
                </button>
            </div>
            <div class="item-box full-width" style="background: rgba(230, 126, 34, 0.2);">
                <span style="font-size:0.7rem">„Çè„Çâ‰∫∫ÂΩ¢Âº∑Âåñ Lv<span id="cur-lv-doll">1</span></span>
                <button class="upgrade-btn" id="btn-doll" style="background: #e67e22;">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv</span>
                    <span class="cost-tag"><span id="cost-doll">50</span> pt</span>
                </button>
            </div>
        </div>

        <div class="reset-area">
            <button id="btn-reset">„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã</button>
        </div>
    </div>

    <script>
        let points = 0;
        let totalDamage = 0;
        let userName = "";
        let currentMultiplier = 1;

        const RANKS = [
            { threshold: 0, title: "‰∏ÄËà¨‰∫∫" },
            { threshold: 1000, title: "ÂàùÂøÉËÄÖ" },
            { threshold: 5000, title: "‰∏≠Á¥öËÄÖ" },
            { threshold: 20000, title: "‰∏äÁ¥öËÄÖ" },
            { threshold: 100000, title: "„Éó„É≠" },
            { threshold: 500000, title: "„Ç®„Ç≠„Çπ„Éë„Éº„Éà" },
            { threshold: 1000000, title: "ÈÅî‰∫∫" },
            { threshold: 10000000, title: "‰ªô‰∫∫" },
            { threshold: 100000000, title: "Á•û" }
        ];

        let eventTimer = 90; 
        let activeEvent = null;
        let eventDuration = 0;
        let bossMode = false;
        let bossHP = 0;
        let bossMaxHP = 0;

        const state = {
            sword: { lv: 0, cost: 10, baseCost: 10 },
            gun: { lv: 0, cost: 100, baseCost: 100 },
            gem: { lv: 0, cost: 500, baseCost: 500 },
            turret: { lv: 0, cost: 1000, baseCost: 1000 },
            doll: { lv: 1, cost: 50, baseCost: 50 }
        };

        const dollEl = document.getElementById('straw-doll');
        const dollContainer = document.getElementById('doll-container');
        const eventTimerEl = document.getElementById('event-timer-display');
        const bannerEl = document.getElementById('event-banner');

        function saveGame() {
            localStorage.setItem('straw_doll_v2_save', JSON.stringify({ points, totalDamage, userName, state }));
        }

        function loadGame() {
            const saved = localStorage.getItem('straw_doll_v2_save');
            if (saved) {
                const data = JSON.parse(saved);
                points = data.points || 0;
                totalDamage = data.totalDamage || 0;
                userName = data.userName || "";
                if(data.state) Object.keys(state).forEach(k => { if(data.state[k]) state[k].lv = data.state[k].lv; });
            }
        }

        function updateRankUI() {
            let currentTitle = RANKS[0].title;
            for (let i = RANKS.length - 1; i >= 0; i--) {
                if (totalDamage >= RANKS[i].threshold) {
                    currentTitle = RANKS[i].title;
                    break;
                }
            }
            document.getElementById('current-rank').innerText = currentTitle;
        }

        function startEvent() {
            const events = ["DMG_X2", "DMG_HALF", "PT_X2", "PT_HALF", "COST_HALF", "COST_X2", "BOSS"];
            const choice = events[Math.floor(Math.random() * events.length)];
            activeEvent = choice;
            
            if (choice === "BOSS") {
                spawnBoss();
            } else {
                eventDuration = 30;
                const labels = {
                    "DMG_X2": "üî• „ÉÄ„É°„Éº„Ç∏2ÂÄçÔºÅ", "DMG_HALF": "‚ùÑÔ∏è „ÉÄ„É°„Éº„Ç∏1/2...",
                    "PT_X2": "üí∞ „Éù„Ç§„É≥„ÉàÂÄçÁéá2ÂÄçÔºÅ", "PT_HALF": "üí∏ „Éù„Ç§„É≥„ÉàÂÄçÁéá1/2...",
                    "COST_HALF": "üõ†Ô∏è „Ç≥„Çπ„Éà1/2ÔºÅ", "COST_X2": "‚ö†Ô∏è „Ç≥„Çπ„Éà2ÂÄç..."
                };
                bannerEl.innerText = labels[choice];
                bannerEl.style.display = "block";
            }
        }

        function spawnBoss() {
            bossMode = true;
            eventDuration = 30;
            // „Éó„É¨„Ç§„É§„Éº„ÅÆÂº∑„Åï„Å´Âêà„Çè„Åõ„Å¶HP„ÇíË®àÁÆó
            bossMaxHP = ((state.turret.lv + (state.gem.lv) * 0.3) * 0.2 * 600) + 
                         ((1 + (state.sword.lv) * 0.5 + (state.gem.lv) * 0.3) + 
                         ((state.gun.lv + (state.gem.lv) * 0.3) * 0.1 * 10)) * 900;
            
            if(bossMaxHP < 100) bossMaxHP = 100; // ÊúÄ‰ΩéHP
            bossHP = bossMaxHP;
            
            dollEl.innerText = "üëπ";
            document.getElementById('boss-hp-container').style.display = "block";
            updateBossUI();
            bannerEl.innerText = "‚ò¢Ô∏è BOSSÂá∫ÁèæÔºÅ30Áßí‰ª•ÂÜÖ„Å´ÂÄí„ÅõÔºÅ";
            bannerEl.style.display = "block";
            bannerEl.style.background = "#ff4757";
        }

        function updateBossUI() {
            const pct = (bossHP / bossMaxHP) * 100;
            document.getElementById('boss-hp-bar').style.width = Math.max(0, pct) + "%";
        }

        function endEvent() {
            activeEvent = null;
            bossMode = false;
            bannerEl.style.display = "none";
            bannerEl.style.background = "#f1c40f";
            document.getElementById('boss-hp-container').style.display = "none";
            dollEl.innerText = "üåæ";
            eventTimer = 90;
        }

        setInterval(() => {
            if (activeEvent) {
                eventDuration--;
                if (bossMode) {
                    eventTimerEl.innerText = `„Éú„ÇπÁµÇ‰∫Ü„Åæ„Åß: ${eventDuration}s`;
                    if (eventDuration <= 0) {
                        alert("„Éú„Çπ„ÇíÂÄí„Åõ„Å™„Åã„Å£„Åü...„Éù„Ç§„É≥„Éà„ÅåÊ≤°Âèé„Åï„Çå„Åæ„Åó„ÅüÔºÅ");
                        points = 0; // „Çπ„Ç≥„Ç¢Ôºà„Éù„Ç§„É≥„ÉàÔºâ„Çí„É™„Çª„ÉÉ„Éà
                        saveGame();
                        updateUI();
                        endEvent();
                    }
                } else {
                    eventTimerEl.innerText = `„Ç§„Éô„É≥„ÉàÁµÇ‰∫Ü„Åæ„Åß: ${eventDuration}s`;
                    if (eventDuration <= 0) endEvent();
                }
            } else {
                eventTimer--;
                let m = Math.floor(eventTimer / 60);
                let s = eventTimer % 60;
                eventTimerEl.innerText = `Ê¨°„Åæ„Åß: ${m}:${s.toString().padStart(2, '0')}`;
                if (eventTimer <= 0) startEvent();
            }
        }, 1000);

        function getBulkCost(key, amount) {
            if (amount < 1) return 0;
            const item = state[key];
            let startLv = (key === 'doll') ? item.lv : item.lv + 1;
            let endLv = startLv + amount - 1;
            let sum = (amount * (startLv + endLv)) / 2;
            let total = Math.floor(sum * item.baseCost);
            
            if (activeEvent === "COST_HALF") total *= 0.5;
            if (activeEvent === "COST_X2") total *= 2;
            return Math.floor(total);
        }

        function applyDamage(dmg) {
            if (dmg <= 0) return;
            if (activeEvent === "DMG_X2") dmg *= 2;
            if (activeEvent === "DMG_HALF") dmg *= 0.5;

            if (bossMode) {
                bossHP -= dmg;
                updateBossUI();
                if (bossHP <= 0) {
                    // „Éú„ÇπHP„Åå0‰ª•‰∏ã„Å´„Å™„Å£„Åü„ÇâÂç≥Â∫ß„Å´ÁµÇ‰∫ÜÂá¶ÁêÜ
                    bossHP = 0;
                    updateBossUI();
                    setTimeout(() => {
                        alert("„Éú„ÇπÊíÉÁ†¥ÔºÅ„Éú„Éº„Éä„Çπ10,000ptÔºÅ");
                        points += 10000;
                        endEvent();
                        updateUI();
                        saveGame();
                    }, 10);
                    return; // ÊíÉÁ†¥ÊôÇ„ÅØ„Åì„Åì„ÅßÂá¶ÁêÜÁµÇ‰∫Ü
                }
            }

            totalDamage += dmg;
            let ptGain = dmg * state.doll.lv;
            if (activeEvent === "PT_X2") ptGain *= 2;
            if (activeEvent === "PT_HALF") ptGain *= 0.5;
            
            points += ptGain;
            showDamageText(dmg);
            triggerShake(); 
            updateUI();
            saveGame();
        }

        function triggerShake() {
            dollEl.style.setProperty('--sx', (Math.random() - 0.5) * 30 + "px");
            dollEl.style.setProperty('--sy', (Math.random() - 0.5) * 30 + "px");
            dollEl.style.setProperty('--sr', (Math.random() - 0.5) * 15 + "deg");
            dollEl.classList.remove('shake-active');
            void dollEl.offsetWidth; 
            dollEl.classList.add('shake-active');
        }

        function showDamageText(dmg) {
            const el = document.createElement('div');
            el.className = 'damage-popup';
            el.innerText = `-${Math.ceil(dmg)}`;
            el.style.left = `calc(50% + ${(Math.random() - 0.5) * 150}px)`;
            el.style.top = `calc(50% + ${(Math.random() - 0.5) * 80}px)`;
            el.style.setProperty('--rx', `${(Math.random() - 0.5) * 120}px`);
            dollContainer.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        dollEl.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            applyDamage(Math.ceil(1 + (state.sword.lv) * 0.5 + (state.gem.lv) * 0.3));
            if (state.gun.lv > 0) {
                let count = 0;
                const gunInterval = setInterval(() => {
                    applyDamage(Math.ceil((state.gun.lv + (state.gem.lv) * 0.3) * 0.1));
                    if (++count >= 10) clearInterval(gunInterval);
                }, 30);
            }
        });

        setInterval(() => {
            if (state.turret.lv > 0) applyDamage(Math.ceil((state.turret.lv + (state.gem.lv) * 0.3) * 0.2));
        }, 50);

        function updateUI() {
            document.getElementById('points').innerText = Math.ceil(points).toLocaleString();
            document.getElementById('total-damage').innerText = Math.ceil(totalDamage).toLocaleString();
            document.querySelectorAll('.plus-val').forEach(el => el.innerText = currentMultiplier.toLocaleString());
            Object.keys(state).forEach(key => {
                const item = state[key];
                const bulkCost = getBulkCost(key, currentMultiplier);
                document.getElementById(`cur-lv-${key}`).innerText = item.lv.toLocaleString();
                document.getElementById(`cost-${key}`).innerText = bulkCost.toLocaleString();
                document.getElementById(`btn-${key}`).disabled = (points < bulkCost);
            });
            updateRankUI();
        }

        function resetData() {
            if (confirm("ÂÖ®„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÅãÔºü")) {
                localStorage.removeItem('straw_doll_v2_save');
                localStorage.clear(); // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„ÇíÂÆåÂÖ®„Å´„ÇØ„É™„Ç¢
                points = 0;
                totalDamage = 0;
                state.sword.lv = 0;
                state.gun.lv = 0;
                state.gem.lv = 0;
                state.turret.lv = 0;
                state.doll.lv = 0;
                // „Éö„Éº„Ç∏„ÇíÂº∑Âà∂„É™„É≠„Éº„Éâ„Åó„Å¶ÂàùÊúüÂåñ
                location.reload(true);
            }
        }

        document.getElementById('btn-reset').addEventListener('click', () => resetData());
        document.getElementById('input-multiplier').addEventListener('input', (e) => {
            currentMultiplier = parseInt(e.target.value) || 1;
            updateUI();
        });

        Object.keys(state).forEach(key => {
            document.getElementById(`btn-${key}`).addEventListener('click', () => {
                const needed = getBulkCost(key, currentMultiplier);
                if (points >= needed) {
                    points -= needed;
                    state[key].lv += currentMultiplier;
                    updateUI();
                    saveGame();
                }
            });
        });

        loadGame();
        updateUI();
    </script>
</body>
</html>