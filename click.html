<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€£æ‰“ã‚²ãƒ¼ãƒ  - ã‚ã‚‰äººå½¢</title>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic ProN', sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation; 
            overflow: hidden;
        }

        #game-container {
            background: #34495e;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            width: 100%;
            max-width: 420px;
            max-height: 95vh;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .status-panel {
            background: #1a252f;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        .status-item { font-size: 0.9rem; margin: 2px 0; }
        .highlight { color: #f1c40f; font-weight: bold; font-size: 1.2rem; }

        #doll-container {
            position: relative;
            display: inline-block;
            margin: 10px 0;
            flex-shrink: 0;
        }

        #straw-doll {
            font-size: clamp(60px, 20vw, 100px);
            cursor: pointer;
            display: inline-block;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .multiplier-config {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .multiplier-config label { font-size: 0.85rem; }
        #input-multiplier {
            width: 80px;
            padding: 5px;
            border-radius: 5px;
            border: none;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
        }

        @keyframes random-shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(var(--sx), var(--sy)) rotate(var(--sr)); }
            50% { transform: translate(calc(var(--sx) * -0.8), calc(var(--sy) * -0.8)) rotate(calc(var(--sr) * -0.8)); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
        .shake-active { animation: random-shake 0.08s linear forwards; }

        .shop { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 5px;
        }
        
        .item-box {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .item-box.full-width { grid-column: span 2; }

        .current-lv-label {
            font-size: 0.75rem;
            color: #bdc3c7;
        }

        .upgrade-btn { 
            background: #27ae60; 
            border: none; 
            padding: 8px 4px; 
            color: white; 
            border-radius: 8px; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            transition: background 0.2s;
        }
        .upgrade-btn:disabled { background: #7f8c8d; opacity: 0.6; cursor: not-allowed; }
        .next-tag { font-weight: bold; font-size: 0.8rem; }
        .cost-tag { font-size: 0.7rem; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 2px;}

        .damage-popup {
            position: absolute;
            color: #ff4757;
            font-weight: bold;
            font-size: 1.2rem;
            pointer-events: none;
            animation: float-up 0.6s ease-out forwards;
        }
        @keyframes float-up {
            0% { opacity: 1; transform: translate(0, 0) scale(1.2); }
            100% { opacity: 0; transform: translate(var(--rx), -80px) scale(0.8); }
        }

        .reset-area { margin-top: 15px; border-top: 1px solid #5d6d7e; padding-top: 10px; }
        #btn-reset { background: #c0392b; color: #ecf0f1; border: none; padding: 6px 12px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; opacity: 0.7; }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="status-panel">
            <div class="status-item">ãƒã‚¤ãƒ³ãƒˆ: <span id="points" class="highlight">0</span> pt</div>
            <div class="status-item">ç·ãƒ€ãƒ¡ãƒ¼ã‚¸: <span id="total-damage">0</span></div>
        </div>

        <div id="doll-container">
            <div id="straw-doll">ğŸŒ¾</div>
        </div>

        <div class="multiplier-config">
            <label for="input-multiplier">ä¸€æ‹¬è³¼å…¥æ•°:</label>
            <input type="number" id="input-multiplier" value="1" min="1">
        </div>

        <div class="shop">
            <div class="item-box">
                <span class="current-lv-label">å‰£ ç¾åœ¨: Lv<span id="cur-lv-sword">0</span></span>
                <button class="upgrade-btn" id="btn-sword">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv (â¡ Lv<span id="next-lv-sword">1</span>)</span>
                    <span class="cost-tag"><span id="cost-sword">10</span> pt</span>
                </button>
            </div>
            <div class="item-box">
                <span class="current-lv-label">éŠƒ ç¾åœ¨: Lv<span id="cur-lv-gun">0</span></span>
                <button class="upgrade-btn" id="btn-gun">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv (â¡ Lv<span id="next-lv-gun">1</span>)</span>
                    <span class="cost-tag"><span id="cost-gun">100</span> pt</span>
                </button>
            </div>
            <div class="item-box">
                <span class="current-lv-label">ã‚¸ã‚§ãƒ  ç¾åœ¨: Lv<span id="cur-lv-gem">0</span></span>
                <button class="upgrade-btn" id="btn-gem">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv (â¡ Lv<span id="next-lv-gem">1</span>)</span>
                    <span class="cost-tag"><span id="cost-gem">500</span> pt</span>
                </button>
            </div>
            <div class="item-box">
                <span class="current-lv-label">ã‚¿ãƒ¬ãƒƒãƒˆ ç¾åœ¨: Lv<span id="cur-lv-turret">0</span></span>
                <button class="upgrade-btn" id="btn-turret">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv (â¡ Lv<span id="next-lv-turret">1</span>)</span>
                    <span class="cost-tag"><span id="cost-turret">1000</span> pt</span>
                </button>
            </div>
            <div class="item-box full-width" style="background: rgba(230, 126, 34, 0.2);">
                <span class="current-lv-label">ã‚ã‚‰äººå½¢å¼·åŒ– ç¾åœ¨: Lv<span id="cur-lv-doll">1</span></span>
                <button class="upgrade-btn" id="btn-doll" style="background: #e67e22;">
                    <span class="next-tag">+<span class="plus-val">1</span> Lv (â¡ Lv<span id="next-lv-doll">2</span>)</span>
                    <span class="cost-tag"><span id="cost-doll">50</span> pt</span>
                </button>
            </div>
        </div>

        <div class="reset-area">
            <button id="btn-reset">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
        </div>
    </div>

    <script>
        let points = 0;
        let totalDamage = 0;
        let currentMultiplier = 1;

        const state = {
            sword: { lv: 0, cost: 10, baseCost: 10 },
            gun: { lv: 0, cost: 100, baseCost: 100 },
            gem: { lv: 0, cost: 500, baseCost: 500 },
            turret: { lv: 0, cost: 1000, baseCost: 1000 },
            doll: { lv: 1, cost: 50, baseCost: 50 }
        };

        const dollEl = document.getElementById('straw-doll');
        const dollContainer = document.getElementById('doll-container');
        const multInput = document.getElementById('input-multiplier');

        // ç­‰å·®æ•°åˆ—ã®å’Œã‚’ç”¨ã„ãŸä¸€æ‹¬ã‚³ã‚¹ãƒˆè¨ˆç®—
        function getBulkCost(key, amount) {
            if (amount < 1) return 0;
            const item = state[key];
            let startLv = (key === 'doll') ? item.lv : item.lv + 1;
            let endLv = startLv + amount - 1;
            // å’Œã®å…¬å¼: (é …æ•° * (åˆé … + æœ«é …)) / 2 * baseCost
            let sum = (amount * (startLv + endLv)) / 2;
            return Math.floor(sum * item.baseCost);
        }

        multInput.addEventListener('input', () => {
            let val = parseInt(multInput.value);
            if (isNaN(val) || val < 1) val = 1;
            currentMultiplier = val;
            updateUI();
        });

        function saveGame() {
            localStorage.setItem('straw_doll_save', JSON.stringify({ points, totalDamage, state }));
        }

        function loadGame() {
            const saved = localStorage.getItem('straw_doll_save');
            if (saved) {
                const data = JSON.parse(saved);
                points = data.points || 0;
                totalDamage = data.totalDamage || 0;
                Object.keys(state).forEach(key => {
                    if (data.state[key]) {
                        state[key].lv = data.state[key].lv;
                    }
                });
            }
        }

        document.getElementById('btn-reset').addEventListener('click', () => {
            if (confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ")) {
                // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’å‰Šé™¤
                localStorage.removeItem('straw_doll_save');
                
                // 2. ãƒ¡ãƒ¢ãƒªä¸Šã®å¤‰æ•°ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™ï¼ˆå¿µã®ãŸã‚ï¼‰
                points = 0;
                totalDamage = 0;
                state.sword.lv = 0;
                state.gun.lv = 0;
                state.gem.lv = 0;
                state.turret.lv = 0;
                state.doll.lv = 1;

                // 3. ãƒšãƒ¼ã‚¸ã‚’å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
                // trueã‚’å…¥ã‚Œã‚‹ã¨ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ã®çŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿ã¾ã™
                location.replace(location.href); 
            }
        });

        function applyDamage(dmg) {
            if (dmg <= 0) return;
            totalDamage += dmg;
            points += dmg * state.doll.lv;
            showDamageText(dmg);
            triggerShake(); 
            updateUI();
            saveGame();
        }

        function triggerShake() {
            dollEl.style.setProperty('--sx', (Math.random() - 0.5) * 30 + "px");
            dollEl.style.setProperty('--sy', (Math.random() - 0.5) * 30 + "px");
            dollEl.style.setProperty('--sr', (Math.random() - 0.5) * 15 + "deg");
            dollEl.classList.remove('shake-active');
            void dollEl.offsetWidth; 
            dollEl.classList.add('shake-active');
        }

        function showDamageText(dmg) {
            const el = document.createElement('div');
            el.className = 'damage-popup';
            el.innerText = `-${dmg}`;
            el.style.left = `calc(50% + ${(Math.random() - 0.5) * 150}px)`;
            el.style.top = `calc(50% + ${(Math.random() - 0.5) * 80}px)`;
            el.style.setProperty('--rx', `${(Math.random() - 0.5) * 120}px`);
            dollContainer.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        dollEl.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            applyDamage(1 + state.sword.lv + state.gem.lv);
            if (state.gun.lv > 0) {
                let count = 0;
                const gunInterval = setInterval(() => {
                    applyDamage(state.gun.lv + state.gem.lv);
                    if (++count >= 10) clearInterval(gunInterval);
                }, 30);
            }
        });

        setInterval(() => {
            if (state.turret.lv > 0) applyDamage(state.turret.lv + state.gem.lv);
        }, 50);

        function upgrade(key) {
            const needed = getBulkCost(key, currentMultiplier);
            if (points >= needed) {
                points -= needed;
                state[key].lv += currentMultiplier;
                updateUI();
                saveGame();
            }
        }

        Object.keys(state).forEach(key => {
            document.getElementById(`btn-${key}`).addEventListener('click', (e) => {
                e.preventDefault();
                upgrade(key);
            });
        });

        function updateUI() {
            document.getElementById('points').innerText = Math.floor(points).toLocaleString();
            document.getElementById('total-damage').innerText = Math.floor(totalDamage).toLocaleString();
            
            document.querySelectorAll('.plus-val').forEach(el => el.innerText = currentMultiplier.toLocaleString());

            Object.keys(state).forEach(key => {
                const item = state[key];
                const bulkCost = getBulkCost(key, currentMultiplier);
                
                document.getElementById(`cur-lv-${key}`).innerText = item.lv.toLocaleString();
                document.getElementById(`next-lv-${key}`).innerText = (item.lv + currentMultiplier).toLocaleString();
                document.getElementById(`cost-${key}`).innerText = bulkCost.toLocaleString();
                document.getElementById(`btn-${key}`).disabled = (points < bulkCost || currentMultiplier < 1);
            });
        }

        loadGame();
        updateUI();
    </script>
</body>
</html>